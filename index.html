<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>DT Union · 社团门户</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<style>
  .page{display:none}
  .glass{backdrop-filter:saturate(140%) blur(8px); background:rgba(255,255,255,.65)}
  .hero{background:url('https://images.unsplash.com/photo-1521412644187-c49fa049e84d?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat}
  .card{transition:transform .2s ease, box-shadow .2s ease}
  .card:hover{transform:translateY(-2px); box-shadow:0 12px 25px rgba(0,0,0,.08)}
</style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- 顶部导航 -->
<nav class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="font-black text-2xl tracking-wide">DT Union</div>
    <div class="hidden md:flex items-center gap-6 text-sm">
      <a href="#" onclick="go('home')" class="hover:text-blue-700">主页</a>
      <a href="#" onclick="go('logic')" class="hover:text-blue-700">推理俱乐部</a>
      <a href="#" onclick="go('soccer')" class="hover:text-blue-700">足球俱乐部</a>
      <a href="#" onclick="go('fitness')" class="hover:text-blue-700">健身打卡</a>
      <a href="#" onclick="go('myposts')" class="hover:text-blue-700">我的帖子</a>
      <a href="#" onclick="go('auth')" class="hover:text-blue-700">登录/注册</a>
      <span id="adminMenu" class="hidden">
        <a href="#" onclick="go('admin')" class="text-amber-700 font-semibold">后台</a>
      </span>
    </div>
    <div id="statusBar" class="text-xs sm:text-sm italic">当前未登录</div>
  </div>
</nav>

<!-- 主页 -->
<section id="home" class="page block">
  <div class="hero">
    <div class="max-w-5xl mx-auto px-6 py-20">
      <div class="glass rounded-2xl p-8 shadow-lg">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight">欢迎来到 DT Union</h1>
        <p class="mt-3 text-slate-700 text-lg">推理 · 足球 · 健身 —— 一个汇聚思考与汗水的社区。</p>
        <div class="mt-6 flex gap-3">
          <button onclick="go('auth')" class="bg-blue-700 hover:bg-blue-800 text-white px-5 py-2 rounded-xl">立即加入</button>
          <button onclick="go('logic')" class="bg-white hover:bg-slate-100 border px-5 py-2 rounded-xl">看看题库</button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-6 py-12 grid md:grid-cols-3 gap-6">
    <div class="card bg-white rounded-2xl p-6 shadow">
      <h3 class="text-xl font-bold mb-2">推理俱乐部</h3>
      <p class="text-slate-600">发布谜题，分享思路，和同好讨论最优解。</p>
      <button onclick="go('logic')" class="mt-4 text-blue-700 hover:underline">进入题库 →</button>
    </div>
    <div class="card bg-white rounded-2xl p-6 shadow">
      <h3 class="text-xl font-bold mb-2">足球俱乐部</h3>
      <p class="text-slate-600">友谊赛、观赛、战术复盘，球场里外尽情聊。</p>
      <button onclick="go('soccer')" class="mt-4 text-blue-700 hover:underline">查看详情 →</button>
    </div>
    <div class="card bg-white rounded-2xl p-6 shadow">
      <h3 class="text-xl font-bold mb-2">健身打卡</h3>
      <p class="text-slate-600">记录训练与饮食，互相鼓励，见证蜕变。</p>
      <button onclick="go('fitness')" class="mt-4 text-blue-700 hover:underline">开始打卡 →</button>
    </div>
  </div>
</section>

<!-- 登录/注册 + 修改昵称 -->
<section id="auth" class="page max-w-md mx-auto p-6">
  <h2 class="text-2xl font-bold mb-4">登录 / 注册</h2>
  <div class="grid gap-2">
    <input id="email" placeholder="邮箱" class="border p-2 rounded">
    <input id="password" type="password" placeholder="密码" class="border p-2 rounded">
    <div class="flex gap-2">
      <button onclick="register()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded">注册</button>
      <button onclick="login()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded">登录</button>
      <button onclick="logout()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded">退出</button>
    </div>
    <p class="text-xs text-slate-500">注册后需管理员审核通过才能发帖/评论。</p>
  </div>

  <!-- 修改昵称 -->
  <div id="nicknameBox" class="mt-6 hidden">
    <h3 class="text-lg font-semibold mb-2">修改昵称</h3>
    <input id="nicknameInput" placeholder="输入新昵称" class="border p-2 rounded w-full mb-2">
    <button onclick="updateNickname()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">保存昵称</button>
    <p class="text-xs text-slate-500 mt-1">昵称将显示在发帖和评论中。</p>
  </div>
</section>

<!-- 推理俱乐部 -->
<section id="logic" class="page max-w-5xl mx-auto p-6">
  <h2 class="text-3xl font-bold">推理俱乐部 · 题库</h2>
  <div class="mt-4 max-w-2xl">
    <input id="logicTitle" placeholder="题目标题" class="border p-2 rounded w-full mb-2">
    <textarea id="logicContent" placeholder="题目内容（不需要写答案）" class="border p-2 rounded w-full mb-2"></textarea>
    <button onclick="addPost('logic')" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded">发布题目</button>
  </div>
  <div id="posts-logic" class="mt-6 grid gap-4"></div>
</section>

<!-- 足球俱乐部 -->
<section id="soccer" class="page max-w-5xl mx-auto p-6">
  <h2 class="text-3xl font-bold">足球俱乐部</h2>
  <p class="text-slate-700 mt-2">我们定期组织友谊赛、一起观赛复盘战术。后续也可升级为论坛模式。</p>
</section>

<!-- 健身打卡 -->
<section id="fitness" class="page max-w-5xl mx-auto p-6">
  <h2 class="text-3xl font-bold">健身打卡 · 论坛</h2>
  <div class="mt-4 max-w-2xl">
    <input id="fitTitle" placeholder="打卡主题" class="border p-2 rounded w-full mb-2">
    <textarea id="fitContent" placeholder="今天训练了什么？饮食如何？" class="border p-2 rounded w-full mb-2"></textarea>
    <button onclick="addPost('fitness')" class="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded">发布打卡</button>
  </div>
  <div id="posts-fitness" class="mt-6 grid gap-4"></div>
</section>

<!-- 我的帖子 -->
<section id="myposts" class="page max-w-5xl mx-auto p-6">
  <h2 class="text-3xl font-bold">我的帖子</h2>
  <div id="posts-mine" class="mt-6 grid gap-4"></div>
</section>

<!-- 管理员后台 -->
<section id="admin" class="page max-w-5xl mx-auto p-6">
  <h2 class="text-2xl font-bold">管理员后台</h2>
  <div class="mt-6 grid md:grid-cols-2 gap-8">
    <div>
      <h3 class="font-semibold">待审核用户</h3>
      <div id="pendingUsers" class="mt-2"></div>
    </div>
    <div>
      <h3 class="font-semibold">已通过用户</h3>
      <div id="approvedUsers" class="mt-2"></div>
    </div>
  </div>
</section>

<!-- ================= 脚本 ================= -->
<script>
/* ================= 配置 ================= */
const SUPABASE_URL = "https://pagpdgzuvikpdbjupqql.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhZ3BkZ3p1dmlrcGRianVwcXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDQyNzgsImV4cCI6MjA3MzgyMDI3OH0.t7OuWP_leNs74XmXVH2ilg21PqetYEk7NJjPwiF_1lY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
const $ = id => document.getElementById(id);
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

/* 页面切换 + 权限控制 */
function go(id){
  if ((id==='logic'||id==='fitness'||id==='admin'||id==='myposts') && !currentUser){
    alert("请先登录后再访问该页面");
    return go('auth');
  }
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  $(id).style.display='block';
  if (id==='logic') renderPosts('logic');
  if (id==='fitness') renderPosts('fitness');
  if (id==='admin') renderUsers();
  if (id==='myposts') renderMyPosts();
  renderNav();
}

/* 导航渲染 */
function renderNav(){
  if (currentUser){
    const name = currentUser.nickname || currentUser.email;
    $('statusBar').textContent = `当前用户：${name}${currentUser.is_admin?'（管理员）':''}`;
  } else {
    $('statusBar').textContent = '当前未登录';
  }
  $('adminMenu').classList.toggle('hidden', !(currentUser && currentUser.is_admin));
  const nickBox = $('nicknameBox'); if (nickBox) nickBox.style.display = currentUser?'block':'none';
}

/* 启动 */
async function bootstrap(){
  const { data:{ session } } = await sb.auth.getSession();
  if (session?.user){
    const { data: prof } = await sb.from('profiles').select('*').eq('id', session.user.id).maybeSingle();
    if (prof){
      currentUser = { id: prof.id, email: prof.email, nickname: prof.nickname, is_admin: prof.is_admin, approved: prof.approved };
    }
  }
  renderNav(); go('home');
}

/* 注册/登录/退出/昵称 */
async function register(){
  const email=$('email').value.trim(), pass=$('password').value;
  if(!email||!pass) return alert("请输入邮箱和密码");
  const { error } = await sb.auth.signUp({ email, password:pass });
  if(error) return alert(error.message);
  alert("注册成功，请到邮箱确认后再登录");
}
async function login(){
  const email=$('email').value.trim(), pass=$('password').value;
  const { error } = await sb.auth.signInWithPassword({ email,password:pass });
  if(error) return alert(error.message);
  const { data:{ user } } = await sb.auth.getUser();
  await sb.from('profiles').upsert({ id:user.id,email:user.email }).select().single();
  const { data: prof } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
  if(!prof?.approved) return alert("等待管理员审核中");
  currentUser = { id:user.id,email:user.email,nickname:prof.nickname,is_admin:prof.is_admin,approved:prof.approved };
  renderNav(); alert("登录成功"); go('home');
}
async function logout(){ await sb.auth.signOut(); currentUser=null; renderNav(); go('home'); }
async function updateNickname(){
  if(!currentUser) return alert("请先登录");
  const nick=$('nicknameInput').value.trim(); if(!nick) return alert("昵称不能为空");
  await sb.from('profiles').update({ nickname:nick }).eq('id', currentUser.id);
  currentUser.nickname=nick; renderNav(); alert("昵称已更新！");
}

/* 发帖/评论/删除/置顶 */
async function addPost(type){
  const title=$(type==='logic'?'logicTitle':'fitTitle').value.trim();
  const content=$(type==='logic'?'logicContent':'fitContent').value.trim();
  if(!currentUser) return alert("请先登录");
  if(!title||!content) return alert("请输入标题和内容");
  await sb.from('posts').insert({ type,title,content,author_id:currentUser.id,author_email:currentUser.email,author_nickname:currentUser.nickname,pinned:false });
  if(type==='logic'){ $('logicTitle').value=''; $('logicContent').value=''; } else { $('fitTitle').value=''; $('fitContent').value=''; }
  renderPosts(type);
}
async function addComment(postId,type){
  if(!currentUser) return alert("请先登录");
  const input=$(`cmt-${postId}`); const body=input.value.trim(); if(!body) return;
  await sb.from('comments').insert({ post_id:postId,body,author_id:currentUser.id,author_email:currentUser.email,author_nickname:currentUser.nickname });
  input.value=''; renderPosts(type);
}
async function deletePost(postId,type){
  if(!confirm("确认删除该帖子？")) return;
  await sb.from('posts').delete().eq('id',postId);
  await sb.from('comments').delete().eq('post_id',postId);
  renderPosts(type);
}
async function deleteComment(cmtId,type){
  if(!confirm("确认删除该评论？")) return;
  await sb.from('comments').delete().eq('id',cmtId);
  renderPosts(type);
}
async function togglePin(postId,currentState,type){
  await sb.from('posts').update({ pinned:!currentState }).eq('id',postId);
  renderPosts(type);
}

/* 渲染帖子 */
async function renderPosts(type){
  if(!currentUser){ alert("请先登录才能查看帖子"); return go('auth'); }
  const box=$(`posts-${type}`); box.innerHTML='';
  const { data:list } = await sb.from('posts')
    .select('id,type,title,content,author_email,author_nickname,author_id,created_at,pinned')
    .eq('type',type)
    .order('pinned',{ascending:false})
    .order('id',{ascending:false});
  for(const p of (list||[])){
    const { data:cmts } = await sb.from('comments')
      .select('id,post_id,body,author_email,author_nickname,author_id,created_at')
      .eq('post_id',p.id)
      .order('id');
    box.appendChild(renderPostCard(p,cmts||[]));
  }
}

/* 渲染我的帖子 */
async function renderMyPosts(){
  if (!currentUser){ alert("请先登录"); return go('auth'); }
  const box = $('posts-mine'); box.innerHTML = '';
  const { data:list } = await sb.from('posts')
    .select('id,type,title,content,author_email,author_nickname,author_id,created_at,pinned')
    .eq('author_id', currentUser.id)
    .order('id',{ascending:false});
  for (const p of (list||[])){
    const { data: cmts } = await sb.from('comments')
      .select('id,post_id,body,author_email,author_nickname,author_id,created_at')
      .eq('post_id', p.id)
      .order('id');
    box.appendChild(renderPostCard(p, cmts||[]));
  }
}

/* 渲染帖子卡片 */
function renderPostCard(p,comments){
  const card=document.createElement('div'); card.className="bg-white rounded-2xl shadow p-5";
  const ts=p.created_at?new Date(p.created_at).toLocaleString():'';
  const isAdmin=currentUser&&currentUser.is_admin;
  const canDeletePost=currentUser&&(isAdmin||currentUser.id===p.author_id);
  card.innerHTML=`
    <h3 class="text-xl font-bold">${p.pinned?"⭐ ":""}${escapeHtml(p.title)}</h3>
    <p class="mt-2 text-slate-700 whitespace-pre-wrap">${escapeHtml(p.content)}</p>
    <div class="text-xs text-slate-500 mt-2">作者：${escapeHtml(p.author_nickname||p.author_email||'未知')} · 时间：${ts}</div>
    <div class="mt-3 flex items-center gap-2">
      <input id="cmt-${p.id}" placeholder="写评论…" class="border p-2 rounded w-2/3">
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="addComment(${p.id}, '${p.type}')">回复</button>
      ${canDeletePost?`<button class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded" onclick="deletePost(${p.id}, '${p.type}')">删帖</button>`:''}
      ${isAdmin?`<button class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1 rounded" onclick="togglePin(${p.id}, ${p.pinned}, '${p.type}')">${p.pinned?'取消置顶':'置顶'}</button>`:''}
    </div>
    <div class="mt-2 space-y-1">
      ${(comments||[]).map(c=>{
        const canDeleteCmt=currentUser&&(isAdmin||currentUser.id===c.author_id);
        return `<div class="text-sm text-slate-800">💬 ${escapeHtml(c.author_nickname||c.author_email)}：${escapeHtml(c.body)} <span class="text-xs text-slate-500">(${c.created_at?new Date(c.created_at).toLocaleString():''})</span>
        ${canDeleteCmt?`<button class="text-rose-600 text-xs ml-2" onclick="deleteComment(${c.id}, '${p.type}')">删除</button>`:''}</div>`
      }).join('')}
    </div>
  `;
  return card;
}

/* 后台 */
async function renderUsers(){
  if(!(currentUser&&currentUser.is_admin)){ alert("仅管理员可访问"); return go('home'); }
  const pending=$('pendingUsers'); const approved=$('approvedUsers');
  pending.innerHTML=''; approved.innerHTML='';
  const { data } = await sb.from('profiles').select('id,email,nickname,is_admin,approved').order('email');
  data.forEach(row=>{
    const html=document.createElement('div');
    html.className="p-2 border rounded mt-2 flex justify-between items-center bg-white";
    if(!row.approved){
      html.innerHTML=`<span>${row.email}${row.nickname?' / '+row.nickname:''}</span>
        <div class="flex gap-2">
          <button class="bg-emerald-600 text-white px-2 py-1 rounded" onclick="approveUser('${row.id}')">通过</button>
        </div>`;
      pending.appendChild(html);
    }else{
      html.innerHTML=`<span>${row.email}${row.is_admin?'（管理员）':''}${row.nickname?' / '+row.nickname:''}</span>`;
      approved.appendChild(html);
    }
  });
}
async function approveUser(uid){ await sb.from('profiles').update({approved:true}).eq('id',uid); renderUsers(); }

bootstrap();
</script>
</body>
</html>






